. "${TIGHTENER_SCRIPTS}/idSetEnv"

if [  "${INDESIGN_TIGHTENER_IS_SERVER}" = "1" ]; then
    PLUG_IN_FILE="${INDESIGN_APP_ROROHIKO_PLUGIN_FOLDER}TightenerServer.InDesignPlugin"
else
    PLUG_IN_FILE="${INDESIGN_APP_ROROHIKO_PLUGIN_FOLDER}Tightener.InDesignPlugin"
fi    

if [  ! -e  "${PLUG_IN_FILE}" ]; then
    echo "Aborting."
    echo "No Tightener Plug-in installed in"
    echo "  ${INDESIGN_APP_ROROHIKO_PLUGIN_FOLDER}."
    echo "You can try using idPluginInstall to install it."
    exit
fi

if [  "${INDESIGN_TIGHTENER_IS_SERVER}" = "1" ]; then
    "${INDESIGN_APP_ROOT}${INDESIGN_APP_FILE}" -console
else

    cat > "${TIGHTENER_SYSCONFIG_ROOT}pokeInDesignTimeslices.applescript" << EOF
use AppleScript version "2.4" -- Yosemite (10.10) or later
use scripting additions

tell application "Adobe InDesign ${INDESIGN_TIGHTENER_VERSION}"
    activate
end tell

tell application "System Events"
    repeat while application process "Adobe InDesign ${INDESIGN_TIGHTENER_VERSION}" exists
        try 
            tell application "Adobe InDesign ${INDESIGN_TIGHTENER_VERSION}"      
                set theResult to do script "app.tightenerTimeslice()" language javascript
            end tell
        end try
        delay 0.1
    end repeat
end tell

EOF

    osascript "${TIGHTENER_SYSCONFIG_ROOT}pokeInDesignTimeslices.applescript" > /dev/null 2>&1
fi
